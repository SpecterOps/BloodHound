package generator

import (
	"fmt"
	"github.com/specterops/bloodhound/packages/go/schemagen/csgen"
	"github.com/specterops/bloodhound/packages/go/schemagen/model"
	"os"
	"path/filepath"
)

type Schema struct {
	Common          model.Graph
	ActiveDirectory model.ActiveDirectory
}

func GenerateCSharpBindings(projectRoot string, commonSchema model.Graph, adSchema model.ActiveDirectory) error {
	path := filepath.Join(projectRoot, "packages/csharp/graphschema/PropertyNames.cs")
	nodes := make([]csgen.SyntaxNode, 0)
	for _, property := range commonSchema.Properties {
		nodes = append(nodes, csgen.BinaryExpression{
			LeftOperand: csgen.ClassMemberAssignment{
				Visibility: csgen.VisibilityPublic,
				Modifier:   csgen.Modifiers{csgen.ModifierConst},
				Type:       csgen.TypeString,
				Symbol:     csgen.Symbol(property.Symbol),
			},
			Operator: csgen.OperatorEquals,
			RightOperand: csgen.Literal{
				Value: property.Representation,
				Null:  false,
			},
		})
	}

	for _, property := range adSchema.Properties {
		nodes = append(nodes, csgen.BinaryExpression{
			LeftOperand: csgen.ClassMemberAssignment{
				Visibility: csgen.VisibilityPublic,
				Modifier:   csgen.Modifiers{csgen.ModifierConst},
				Type:       csgen.TypeString,
				Symbol:     csgen.Symbol(property.Symbol),
			},
			Operator: csgen.OperatorEquals,
			RightOperand: csgen.Literal{
				Value: property.Representation,
				Null:  false,
			},
		})
	}
	topLevel := csgen.Namespace{
		Name: "SharpHoundCommon.Enums",
		Nodes: []csgen.SyntaxNode{
			csgen.Class{
				Modifiers:  csgen.Modifiers{csgen.ModifierStatic},
				Visibility: csgen.VisibilityPublic,
				Name:       "PropertyNames",
				Nodes:      nodes,
			},
		},
	}

	builder := csgen.NewOutputBuilder()
	builder.Write(fmt.Sprintf("// Code generated by Cuelang code gen. DO NOT EDIT!\n// Cuelang source: %s/\n", SchemaSourceName))
	if err := csgen.WalkSyntaxTree(topLevel, builder); err != nil {
		return err
	} else if err := os.WriteFile(path, []byte(builder.Build()), 0644); err != nil {
		return err
	}

	return nil
}
