---
# Copyright 2025 Specter Ops, Inc.
#
# Licensed under the Apache License, Version 2.0
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

name: Manual Grype Vulnerability Scan
run-name: Grype Vulnerability Scan triggered by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      docker_image:
        type: string
        required: true
        description: |-
          The full reference to the Docker container image to scan for vulnerabilities with Grype.
          This should include the registry, repository name, and tag or digest.
          
          Grype will analyze this image for:
          - Known security vulnerabilities (CVEs) in installed packages
          - Operating system vulnerabilities
          - Language-specific package vulnerabilities (npm, pip, gem, etc.)
          - Application dependencies and libraries
          - Base image vulnerabilities
          
          The image must be accessible from the runner environment, either:
          - Publicly available (e.g., from Docker Hub)
          - Accessible with the provided DockerHub credentials
          - Previously built and available locally
          
          Grype supports scanning images from various sources including:
          - Container registries (Docker Hub, ECR, GCR, etc.)
          - Local Docker daemon
          - Archived images (tar files)
          - OCI layout directories
          
          Examples:
          - 'docker.io/specterops/bloodhound:latest'
          - 'myregistry.com/myapp:v1.2.3'
          - 'nginx@sha256:abc123...' (using digest)
        default: 'docker.io/specterops/bloodhound:latest'

jobs:
  scan-image:
    name: Scan Container Image (Grype)
    uses: ./.github/workflows/workflow_call.scan-container-grype.yml
    with:
      docker_image: ${{ inputs.docker_image }}
    secrets:
      dockerhub_account: ${{ secrets.DOCKERHUB_USERNAME }}
      dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
