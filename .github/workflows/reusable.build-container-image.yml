name: Container Image Build Pipeline
run-name: Building Container Image for ${{ inputs.image_repository }} by @${{ github.actor }} on ${{ github.ref_name }}

on:
  workflow_dispatch:
    inputs:
      image_repository:
        type: string
        required: true
        description: >
          The name of the repository where the container image will be stored in the container registry.
          This repository name uniquely identifies the image within the registry.
          Combine this with the 'container_registry' input to form the full URL for the image.

          Example: 'my-app' for a repository named 'my-app' in the container registry.
      dockerfile:
        type: string
        description: >
          The name of the Dockerfile used for building the container image.
          If not specified, it defaults to 'Dockerfile' in the repository root.

          Example: 'Dockerfile.prod' for a production-specific Dockerfile.
      build_target:
        type: string
        description: |-
          The build stage target for multi-stage Docker builds, if applicable.
          Specify this if your Dockerfile has multiple stages, and you want to
          build a specific one.

          Example: 'production' for a multi-stage Dockerfile with a 'production'
          stage.
      image_flavors:
        type: string
        description: |-
          Additional image flavor information or tags.
      image_cache_from:
        type: string
        description: >
          The source image repository from which to cache layers during the build.
          This can help improve build speed by reusing layers from a previously built image.

          Example: 'docker.io/my-app:cache' to cache from a specific image.
      image_cache_to:
        type: string
        description: >
          The destination image cache settings to optimize the caching strategy during the build.
          This input specifies where to store cached layers and how they are scoped.
          Values provided here will be appended to any default cache settings.

          Predefined values may already be present, and any inputs provided here will be appended.

          Example: "type=gha,mode=max,scope=\$\{\{ github.workflow \}\}"
      timeout_minutes:
        description: Job timeout configuration in minutes
        type: number
        default: 30
      push_image:
        type: boolean
        default: false
        description: >
          Whether to push the built container image to the registry after building.
          Set this to 'true' if you want to automatically push the image.

          Example: 'true' to push the image to the registry, 'false' to skip pushing.
  workflow_call:
    inputs:
      build_context:
        type: string
        description: |
          Specifies the build context directory for Docker.
          Choose your build context carefully to:
          - Control which files are available during build
          - Optimize build performance by limiting included files
          - Ensure security by excluding sensitive files
          - Support multi-stage builds with specific contexts
      image_repository:
        type: string
        required: true
        description: >
          The name of the repository where the container image will be stored in the container registry.
          This repository name uniquely identifies the image within the registry.
          Combine this with the 'container_registry' input to form the full URL for the image.

          Example: 'my-app' for a repository named 'my-app' in the container registry.
      dockerfile:
        type: string
        description: >
          The name of the Dockerfile used for building the container image.
          If not specified, it defaults to 'Dockerfile' in the repository root.

          Example: 'Dockerfile.prod' for a production-specific Dockerfile.
      build_target:
        type: string
        description: |-
          The build stage target for multi-stage Docker builds, if applicable.
          Specify this if your Dockerfile has multiple stages, and you want to
          build a specific one.

          Example: 'production' for a multi-stage Dockerfile with a 'production'
          stage.
      build_args:
        type: string
        description: |-
          Build-time variables that customize the container build process.
          Use build args to:
          - Inject version information at build time
          - Configure build-specific settings without modifying Dockerfile
          - Support different configurations for dev/staging/prod
          - Pass secrets safely during build (using --secret)

          Predefined values may already be present, and any inputs provided here will be appended.

          Example: 'VERSION=${GITHUB_SHA}' to embed git commit information
      build_contexts:
        type: string
        description: |-
          Additional named build contexts for multi-stage builds.
          Use multiple build contexts when you need to:
          - Separate build dependencies from runtime dependencies
          - Include files from different locations without copying
          - Optimize layer caching for different build stages
          - Support complex multi-stage build patterns

          In Dockerfile, access these contexts using FROM name or --from=name.
          Note: These contexts override same-named stages in the Dockerfile.

          Example: 'deps=/path/to/dependencies,assets=/path/to/static-files'
      image_provenance:
        type: string
        default: "false"
        description: |-
          Controls inclusion of SLSA provenance in image metadata.
          Enable provenance when you need to:
          - Meet supply chain security requirements
          - Provide audit trails for compliance
          - Verify image build authenticity
          - Support automated security policy enforcement

          Provenance data includes build source, tooling, and environment details.
      image_sbom:
          type: string
          default: "false"
          description: |-
            Controls generation of Software Bill of Materials (SBOM) for the image.
            Enable SBOM generation to:
            - Track and audit all software dependencies
            - Identify and respond to security vulnerabilities
            - Meet compliance requirements for software transparency
            - Support automated vulnerability scanning
            - Enable dependency analysis and lifecycle management
      image_flavor:
        type: string
        description: |-
          Additional image flavor information or tags.
      image_cache_from:
        type: string
        description: >
          The source image repository from which to cache layers during the build.
          This can help improve build speed by reusing layers from a previously built image.

          Example: 'docker.io/my-app:cache' to cache from a specific image.
      image_cache_to:
        type: string
        description: >
          The destination image cache settings to optimize the caching strategy during the build.
          This input specifies where to store cached layers and how they are scoped.
          Values provided here will be appended to any default cache settings.

          Predefined values may already be present, and any inputs provided here will be appended.

          Example: "type=gha,mode=max,scope=\$\{\{ github.workflow \}\}"
      build_output_tar_dir:
        type: string
        description: >
          The directory path where the tar file of the built image will be saved,
          to be used as an artifact upload location with the `actions/upload-artifact@v4` GitHub Action.
          This tar archive can then be retrieved from the workflow artifacts for further use or distribution.
        default: "/tmp"
      timeout_minutes:
        description: Job timeout configuration in minutes
        type: number
        default: 30
      push_image:
        type: boolean
        default: false
        description: |-
          Whether to push the built container image to the registry after building.
          Set this to 'true' if you want to automatically push the image.

          Example: 'true' to push the image to the registry, 'false' to skip pushing.
      build_automation_ref:
        type: string
        description: |-
          When the workflow is reused in another repo, we have to import the
          .github/actions directory for repository.
    secrets:
      dockerhub_account:
        required: true
      dockerhub_token:
        required: true
      ghcr_account:
        required: true
      ghcr_token:
        required: true
      gh_access_token:
        required: true
    outputs:
      image_reference:
        value: ${{ jobs.build-container-image.outputs.image_reference }}
      image_name:
        value: ${{ jobs.build-container-image.outputs.image_name }}
      image_tar_path:
        value: ${{ jobs.build-container-image.outputs.image_tar_path }}
      image_tar_artifact_name:
        value: ${{ jobs.build-container-image.outputs.image_tar_artifact_name }}

jobs:
  build-container-image:
    name: Build and Package ${{ inputs.image_repository }} Container
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout_minutes }}
    outputs:
      image_reference: ${{ steps.container-image-metadata.outputs.image_reference }}
      image_name: ${{ steps.container-image-metadata.outputs.image_name }}
      image_tar_path: ${{ inputs.build_output_tar_dir }}/${{ steps.container-image-metadata.outputs.version }}.tar
      image_tar_artifact_name: ${{ steps.container-image-metadata.outputs.version }}
    steps:
      - name: Checkout Source Code Repository
        uses: actions/checkout@v4

      - if: inputs.build_automation_ref != ''
        name: Checkout Reusable Workflows
        uses: actions/checkout@v4
        with:
          clean: false
          repository: SpecterOps/BloodHound
          ref: ${{ inputs.build_automation_ref }}
          token: ${{ secrets.gh_access_token }}
          sparse-checkout-cone-mode: false
          sparse-checkout: |-
            .github/actions

      - uses: ./.github/actions/container-registry-authentication
        id: dockerhub-authentication
        name: Authenticate with DockerHub Registry
        with:
          container_registry: docker.io
          registry_account: ${{ secrets.dockerhub_account }}
          registry_token: ${{ secrets.dockerhub_token }}

      - uses: ./.github/actions/container-registry-authentication
        id: ghcr-authentication
        name: Authenticate with GitHub Container Registry
        with:
          container_registry: ghcr.io
          registry_account: ${{ secrets.ghcr_account }}
          registry_token: ${{ secrets.ghcr_token }}

      - uses: ./.github/actions/container-image-metadata
        id: container-image-metadata
        with:
          image_repository: ${{ inputs.image_repository }}
          image_flavor: ${{ inputs.image_flavor }}

      - uses: ./.github/actions/build-container-image
        id: build-container-image
        with:
          build_args: ${{ inputs.build_args }}
          build_context: ${{ inputs.build_context }}
          build_contexts: ${{ inputs.build_contexts }}
          build_target: ${{ inputs.build_target }}
          build_outputs: |-
            type=docker,dest=${{ inputs.build_output_tar_dir }}/${{ steps.container-image-metadata.outputs.version }}.tar
          cache_from: ${{ inputs.image_cache_from }}
          cache_to: ${{ inputs.image_cache_to }}
          dockerfile: ${{ inputs.dockerfile }}
          image_labels: ${{ steps.container-image-metadata.outputs.labels }}
          image_metadata_json: ${{ steps.container-image-metadata.outputs.json }}
          image_provenance: ${{ inputs.image_provenance }}
          image_sbom: ${{ inputs.image_sbom }}
          image_tags: ${{ steps.container-image-metadata.outputs.tags }}
          push_image: ${{ inputs.push_image }}

      - if: inputs.build_output_tar_dir != ''
        name: Upload Docker Image Artifact
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          retention-days: 1
          name: ${{ steps.container-image-metadata.outputs.version }}
          path: ${{ inputs.build_output_tar_dir }}/${{ steps.container-image-metadata.outputs.version }}.tar
