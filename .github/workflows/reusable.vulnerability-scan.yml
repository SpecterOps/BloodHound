# Copyright 2024 Specter Ops, Inc.
#
# Licensed under the Apache License, Version 2.0
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

name: Vulnerability Scan

on:
  workflow_call:
    inputs:
      scan_type:
        type: string
        description: |-
          Type of vulnerability scan to perform. Options are:
          - 'repo': Scan entire repository
          - 'fs': Scan local filesystem
          - 'image': Scan container image
          - 'config': Scan config files only

          Defaults to 'repo'
        default: repo
      scan_ref:
        type: string
        description: |-
          The target directory or path to scan for vulnerabilities.
          For image scans, specify the image reference.
          For filesystem scans, specify the directory path.

          Default: './' (current directory)
        default: ./
      severity:
        type: string
        description: |-
          Comma-separated list of vulnerability severity levels to include in results.
          Available levels: CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN
          
          Default: 'CRITICAL,HIGH'
        default: CRITICAL,HIGH
      exit_code:
        type: string
        description: |-
          Exit code to return when vulnerabilities matching the specified severity criteria are found.
          Use '0' to always pass the workflow regardless of findings.
          
          Default: '1' (fail on findings)
        default: '1'
      ignore_unfixed:
        type: boolean
        description: |-
          When true, vulnerabilities that don't have a known fix will be excluded from results.
          Set to true to focus only on vulnerabilities with available patches.
          
          Default: false
        default: false
      trivy_db_repository:
        type: string
        default: ghcr.io/aquasecurity/trivy-db,public.ecr.aws/aquasecurity/trivy-db
      trivy_java_db_repository:
        type: string
        default: ghcr.io/aquasecurity/trivy-java-db,public.ecr.aws/aquasecurity/trivy-java-db

jobs:
  run-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code for this repository
        uses: actions/checkout@v3

      - name: Run vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: ${{ inputs.scan_type }}
          scan-ref: ${{ inputs.scan_ref }}
          severity: ${{ inputs.severity }
          exit-code: ${{ inputs.exit_code }
          ignore-unfixed: ${{ inputs.ignore_unfixed }
        env:
          TRIVY_DB_REPOSITORY: ${{ inputs.trivy_db_repository }}
          TRIVY_JAVA_DB_REPOSITORY: ${{ inputs.trivy_java_db_repository }}
